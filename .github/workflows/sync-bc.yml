name: Sync bc m3u

on:
  schedule:
    - cron: '05 20 * * *'  # UTCæ—¶é—´æ¯å¤©20:05ï¼ˆåŒ—äº¬æ—¶é—´04:05ï¼‰
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Fetch BC source securely
        env: 
          BC_URL: ${{ secrets.BC_SOURCE_URL }}
        run: |
          set -e
          echo "æ­£åœ¨å®‰å…¨åœ°ä»Secretæºä¸‹è½½BCç›´æ’­æº..."
          curl -fL --retry 3 --retry-delay 10 -o bc_raw.m3u "$BC_URL"
          echo "ä¸‹è½½å®Œæˆï¼Œbc_raw.m3u å…±æœ‰ $(wc -l < bc_raw.m3u) è¡Œ"
          test -s bc_raw.m3u || { echo "é”™è¯¯: bc_raw.m3u ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"; exit 1; }
    
      - name: Process & generate bc.m3u
        run: |
          python3 <<'EOF'
          import re, sys
          UA_HINT = "##UA-Hint: è¯·å°† User-Agent è®¾ç½®ä¸º bingcha/1.1ï¼Œå¦åˆ™æ— æ³•è§‚çœ‹"
          
          try:
              with open("bc_raw.m3u", "r", encoding="utf-8", errors="ignore") as f:
                  lines = f.read().splitlines()
          except Exception as e:
              print(f"[ERROR] è¯»å– bc_raw.m3u å¤±è´¥: {e}")
              sys.exit(1)

          if not lines:
              print("[ERROR] bc_raw.m3u ä¸ºç©º")
              sys.exit(1)

          header0 = lines[0].strip() if lines else "#EXTM3U"
          header1 = UA_HINT
          print(f"[INFO] Header: {header0}")

          body = lines[2:] if len(lines) > 2 else []
          bc_channels = []

          # è¿‡æ»¤æ‰ä¸éœ€è¦çš„åˆ†ç»„
          skip_group = re.compile(r'group-title="(4Ké¢‘é“|ç†ŠçŒ«|å½±è§†|åœ°æ–¹|å°‘å„¿|æ•™è‚²|å…¶ä»–|ä½“è‚²|å°è±¡å¤©ä¸‹|çºªå®|ç»¼è‰º|æ–°é—»)")
          # è¿‡æ»¤æ‰ç‰¹å®šçš„é¢‘é“åç§°
          skip_name = re.compile(r'(cgtnru-MCP|cgtndoc-MCP|cgtn-MCP|CGTNALBY|cctv16-MST|cctv8k-MCP|CGTNå¤–è¯­çºªå½•|CGTNé˜¿æ‹‰ä¼¯è¯­|CGTNè¥¿ç­ç‰™è¯­|CGTNæ³•è¯­|CGTNä¿„è¯­|CGTN|è€æ•…äº‹|å‘ç°ä¹‹æ—…|ä¸­å­¦ç”Ÿ|å››æµ·é’“é±¼|24å°æ—¶|æœ€ç»å…¸|ä¼ å¥‡|ä½“å›|ç²¾è‹±|cgtnfr|æ€€æ—§å‰§åœº)')

          i, n = 0, len(body)
          while i < n:
              if not body[i].startswith("#EXTINF"):
                  i += 1
                 
                  continue
              extinf = body[i]
              
              # åº”ç”¨è¿‡æ»¤è§„åˆ™
              if skip_group.search(extinf) or skip_name.search(extinf):
                  i += 2
                  continue
                  
              url = body[i+1] if (i+1 < n and body[i+1].startswith("http")) else None
              if not url:
                  i += 1
                  continue
              
              # åªä¿ç•™å’ªè§†ç•Œç›¸å…³é¢‘é“
              bc_channels += [extinf, url]
              i += 2

          print(f"[INFO] å…±æ‰¾åˆ° {len(bc_channels)//2} ä¸ªå’ªè§†ç•Œé¢‘é“")

          out_lines = [header0, header1] + bc_channels
          with open("bc.m3u", "w", encoding="utf-8") as f:
              f.write("\n".join(out_lines) + "\n")

          # æ˜¾ç¤ºå‰å‡ ä¸ªé¢‘é“ä½œä¸ºé¢„è§ˆ
          preview_count = min(3, len(bc_channels)//2)
          print(f"[PREVIEW] å‰{preview_count}ä¸ªé¢‘é“:")
          for j in range(preview_count*2):
              if j < len(out_lines):
                  print(f"  {out_lines[j]}")
          EOF

      - name: Remove temporary files
        run: |
          rm -f bc_raw.m3u
          echo "å·²æ¸…é™¤ä¸´æ—¶ä¸‹è½½æ–‡ä»¶"

      - name: Commit bc.m3u
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add bc.m3u
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”„ æ›´æ–°å’ªè§†ç•Œç›´æ’­æº $(date +'%Y-%m-%d %H:%M')"
            git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Sync M3U Only

on:
  schedule:
    - cron: '20 21 * * *'  # ä¿æŒåŸæœ‰æ—¶é—´è®¾ç½®
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-m3u:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Log workflow info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Current UTC time: $(date -u)"
          echo "Repository: ${{ github.repository }}"

      - name: Fetch source M3U file
        run: |
          set -e
          echo "å¼€å§‹ä¸‹è½½ M3U æ–‡ä»¶..."
          curl -fL -o iptv.m3u "https://live.ottiptv.cc/iptv.m3u?userid=8257116338&sign=0ee32bfd89ad8fb98abcd834c5bca8a9d2067e9246d1afe59ed28b776baf830aac5a8a3be63250f7b48bff27641ac52755922b1caa12c7d5a7830ed826437d537c6bc26aa6b0d0&auth_token=5fc58b8400b4d34067df90bae9ffe50c"
          
          echo "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -la iptv.m3u
          echo "æ€»è¡Œæ•°ï¼š" && wc -l iptv.m3u
          echo "å‰5è¡Œé¢„è§ˆï¼š" && head -n 5 iptv.m3u
          
          # éªŒè¯æ–‡ä»¶éç©º
          if [ ! -s iptv.m3u ]; then
            echo "âŒ é”™è¯¯ï¼šiptv.m3u æ–‡ä»¶ä¸ºç©ºæˆ–ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          echo "âœ… M3U æ–‡ä»¶ä¸‹è½½æˆåŠŸ"

      - name: Process & generate li.m3u
        run: |
          python3 <<'EOF'
          import re, sys
          UA_HINT = "##UA-Hint: è¯·å°† User-Agent è®¾ç½®ä¸º okHttp/Mod-1.4.0.0 ï¼Œå¦åˆ™æ— æ³•è§‚çœ‹"
          
          print("ğŸš€ å¼€å§‹å¤„ç† M3U æ–‡ä»¶...")
          
          try:
              with open("iptv.m3u", "r", encoding="utf-8", errors="ignore") as f:
                  lines = f.read().splitlines()
          except Exception as e:
              print(f"âŒ è¯»å– iptv.m3u å¤±è´¥ï¼š{e}")
              sys.exit(1)

          if not lines:
              print("âŒ iptv.m3u ä¸ºç©º")
              sys.exit(1)

          header0 = lines[0].strip() if lines else "#EXTM3U"
          header1 = UA_HINT
          print(f"ğŸ“ æ–‡ä»¶å¤´ä¿¡æ¯ï¼š{header0}")
          print(f"ğŸ”§ UA æç¤ºå·²æ·»åŠ ")

          body = lines[2:] if len(lines) > 2 else []
          weishi, cctv, migu, weishi_mcp = [], [], [], []

          skip_group = re.compile(r'group-title="(4Ké¢‘é“|ç†ŠçŒ«|å½±è§†|åœ°æ–¹|å°‘å„¿|æ•™è‚²|å…¶ä»–|ä½“è‚²|å°è±¡å¤©ä¸‹|çºªå®|ç»¼è‰º|æ–°é—»)")
          skip_name  = re.compile(r'(cgtnru-MCP|cgtndoc-MCP|cgtn-MCP|CGTNALBY|cctv16-MST|cctv8k-MCP|CGTNå¤–è¯­çºªå½•|CGTNé˜¿æ‹‰ä¼¯è¯­|CGTNè¥¿ç­ç‰™è¯­|CGTNæ³•è¯­|CGTNä¿„è¯­|CGTN|è€æ•…äº‹|å‘ç°ä¹‹æ—…|ä¸­å­¦ç”Ÿ|å››æµ·é’“é±¼|24å°æ—¶|æœ€ç»å…¸|ä¼ å¥‡|ä½“å›|ç²¾è‹±|cgtnfr|æ€€æ—§å‰§åœº)')

          migu_exclude_name = re.compile(r'(å‰æ—|é’æµ·|æµ·å—|æµ·å³¡|ä¸­å›½å†œæ—|å…µå›¢|æ²³å—|é™•è¥¿|å¤§æ¹¾|ä¸œå—)')
          weishi_mcp_exclude = re.compile(r'(äº‘å—|å…µå›¢|ç”˜è‚ƒ|æ–°ç–†|è¥¿è—|æµ·å—|é’æµ·|å†…è’™å¤|å±±è¥¿|é™•è¥¿|æ²³å—)')

          def is_cctv(extinf): return bool(re.search(r'group-title="[^"]*å¤®è§†"|CCTV|cctv', extinf))
          def is_weishi(extinf): return bool(re.search(r'group-title="[^"]*å«è§†"', extinf))
          def is_weishi_mcp(extinf): return bool(re.search(r'-MCP', extinf))

          i, n = 0, len(body)
          processed_count = 0
          
          while i < n:
              if not body[i].startswith("#EXTINF"):
                  i += 1
                  continue
                  
              extinf = body[i]
              
              # è·³è¿‡ä¸æƒ³è¦çš„ç»„å’Œåç§°
              if skip_group.search(extinf) or skip_name.search(extinf):
                  i += 2
                  continue
                  
              url = body[i+1] if (i+1 < n and body[i+1].startswith("http")) else None
              if not url:
                  i += 1
                  continue
                  
              processed_count += 1
              
              # å’ªå’•é¢‘é“å¤„ç†
              if (re.search(r'migu', url, re.I) or
                   re.search(r'\bmg\b', url, re.I) or
                   'mgtv.ottiptv.cc' in url.lower()):
                  if not migu_exclude_name.search(extinf):
                      migu.extend([extinf, url])
                      
              # MCP å«è§†å¤„ç†
              elif is_weishi(extinf) and is_weishi_mcp(extinf):
                  if not weishi_mcp_exclude.search(extinf):
                      weishi_mcp.extend([extinf, url])
                      
              # æ™®é€šå«è§†
              elif is_weishi(extinf):
                  weishi.extend([extinf, url])
                  
              # å¤®è§†
              elif is_cctv(extinf):
                  cctv.extend([extinf, url])
                  
              # é»˜è®¤å½’ç±»ä¸ºå«è§†
              else:
                  weishi.extend([extinf, url])
                  
              i += 2

          print(f"ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š")
          print(f"   æ€»å…±å¤„ç†é¢‘é“æ•°: {processed_count}")
          print(f"   å¤®è§†é¢‘é“: {len(cctv)//2}")
          print(f"   MCP å«è§†é¢‘é“: {len(weishi_mcp)//2}")
          print(f"   æ™®é€šå«è§†é¢‘é“: {len(weishi)//2}")
          print(f"   å’ªå’•é¢‘é“: {len(migu)//2}")

          # åˆå¹¶æ‰€æœ‰é¢‘é“
          out_lines = [header0, header1] + cctv + weishi_mcp + weishi + migu
          
          with open("li.m3u", "w", encoding="utf-8") as f:
              f.write("\n".join(out_lines) + "\n")

          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          with open("li.m3u", "r", encoding="utf-8") as f:
              output_content = f.readlines()
              print(f"âœ… ç”Ÿæˆçš„ li.m3u å…± {len(output_content)} è¡Œ")
              print("ğŸ“„ å‰10è¡Œé¢„è§ˆï¼š")
              for j, line in enumerate(output_content[:10]):
                  print(f"   {j+1}: {line.strip()}")

          EOF

      - name: Commit and push li.m3u changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "ğŸ”„ æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git status
          git diff li.m3u || echo "æ— å·®å¼‚æ˜¾ç¤ºï¼ˆå¯èƒ½æ˜¯æ–°æ–‡ä»¶ï¼‰"
          
          git add li.m3u
          
          if git diff --cached --quiet; then
            echo "âœ… li.m3u æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            echo "ğŸ“¦ å‡†å¤‡æäº¤å˜æ›´..."
            git commit -m "Auto-update li.m3u via GitHub Actions"
            git push
            echo "ğŸ‰ li.m3u æ›´æ–°å·²æ¨é€åˆ°ä»“åº“"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final status
        run: |
          echo "ğŸ å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "ğŸ“… è§¦å‘æ—¶é—´: $(date)"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}"

name: Sync M3U Only

on:
  schedule:
    - cron: '20 22 * * *'  # 北京时间每天凌晨6点20分
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-m3u:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Fetch source M3U file
        run: |
          set -e
          echo "开始下载IPTV源文件..."
          curl -fL -o iptv.m3u "https://live.ottiptv.cc/iptv.m3u?userid=8257116338&sign=0ee32bfd89ad8fb98abcd98abcd834c5bca8a9d2067e9246d1afe59ed28b776baf830aac5a8a3be63250f7b48bff27641ac52755922b1ca41ac52755922b1caa12c7d5a7830ed826437d537c6bc26aa6b0d0&auth_token=5fc58b8400b4d34067df90bae9ffe50c"
          echo "下载完成，文件信息："
          wc -l iptv.m3u
          echo "文件头部内容："
          head -n 3 iptv.m3u
          test -s iptv.m3u || { echo "错误：iptv.m3u 文件为空或下载失败"; exit 1; }

      - name: Generate filtered M3U file
        run: |
          python3 <<'EOF'
          import re
          import sys
          
          print("开始处理M3U文件...")
          
          # 常量定义
          UA_HINT = "##UA-Hint: 请将 User-Agent 设置为 okHttp/Mod-1.4.0.0 ，否则无法观看"
          
          # 读取源文件
          try:
              with open("iptv.m3u", "r", encoding="utf-8", errors="ignore") as f:
                  lines = f.read().splitlines()
          except Exception as e:
              print(f"[ERROR] 读取 iptv.m3u 失败：{e}")
              sys.exit(1)

          if not lines:
              print("[ERROR] iptv.m3u 为空")
              sys.exit(1)

          # 提取头部
          header0 = lines[0].strip() if lines else "#EXTM3U"
          header1 = UA_HINT
          print(f"[INFO] 文件头：{header0}")
          
          body = lines[2:] if len(lines) > 2 else []
          print(f"[INFO] 待处理频道数量：{len(body)//2}")

          # 过滤规则
          skip_group = re.compile(r'group-title="(4K频道|频道|熊猫|影视|地方|少儿|教育|其他|体育|印象天下|纪实|综艺|新闻)"')
          skip_name  = re.compile(r'(cgtnru-MCP|cgtndoc-MCP|cgtn-MCP|CGTNALBY|cctv16-MST|cctv8k-MCP|CGTN外语纪录|CGTN阿拉伯语|CGTN西班牙语|CGTN法语|CGTN俄语|CGTN|老故事|发现之旅|中学生|四海钓鱼|24小时|最经典|传奇|体坛|精英|cgtnfr|怀旧剧场)')

          migu_exclude_name = re.compile(r'(吉林|青海|海南|海峡|中国农林|兵团|河南|陕西|大湾|东南)')
          weishi_mcp_exclude = re.compile(r'(云南|兵团|甘肃|(r'(云南|兵团|甘肃|新疆|西藏|海南|青海|内蒙古|山西|陕西|河南)')

          # 分类函数
          def is_cctv(extinf): 
              return bool(re.search(r'group-title="[^"]*央视"|CCTV|cctv', extinf, re.IGNORECASE))
              
          def is_weishi(extinf): 
              return bool(re.search(r'group-title="[^"]*卫视"', extinf))
              
          def is_weishi_mcp(extinf): 
              return bool(re.search(r'-MCP', extinf))

          # 分类存储
          weishi, cctv, migu, weishi_mcp = [], [], [], []

          # 处理每个频道条目
          i, processed_count = 0, 0
          n = len(body)
          
          while i < n:
              if not body[i].startswith("#EXTINF"):
                  i += 1
                  continue
                  
              extinf = body[i]
              # 提取频道名（仅用于日志，不影响逻辑）
              channel_name_match = re.search(r',([^,]+)$', extinf)
              channel_name = channel_name_match.group(1) if channel_name_match else "未知"
              
              # 跳过不需要的分组和频道
              if skip_group.search(extinf) or skip_name.search(extinf):
                  i += 2
                  continue

              url = body[i+1] if (i+1 < n and body[i+1].startswith("http")) else None
              if not url:
                  i += 1
                  continue

              processed_count += 1
              
              # 分类逻辑
              if (re.search(r'migu', url, re.I) or
                  re.search(r'\bmg\b', url, re.I) or
                  'mgtv.ottiptv.cc' in url.lower()):
                  if not migu_exclude_name.search(extinf):
                      migu.extend([extinf, url])
                      
              elif is_weishi(extinf) and is_weishi_mcp(extinf):
                  if not weishi_mcp_exclude.search(extinf):
                      weishi_mcp.extend([extinf, url])
                      
              elif is_weishi(extinf):
                  weishi.extend([extinf, url])
                  
              elif is_cctv(extinf):
                  cctv.extend([extinf, url])
                  
              else:
                  weishi.extend([extinf, url])

              i += 2

          # 统计信息
          print(f"\n[INFO] 处理完成统计:")
          print(f"  总处理频道数: {processed_count}")
          print(f"  央视频道: {len(cctv)//2}")
          print(f"  MCP卫视: {len(weishi_mcp)//2}")
          print(f"  普通卫视: {len(weishi)//2}")
          print(f"  咪咕频道: {len(migu)//2}")

          # 合并输出
          out_lines = [header0, header1] + cctv + weishi_mcp + weishi + migu
          
          # 写入文件
          with open("li.m3u", "w", encoding="utf-8") as f:
              f.write("\n".join(out_lines) + "\n")

          # 验证输出
          with open("li.m3u", "r", encoding="utf-8") as f:
              output_content = f.readlines()
              
          print(f"\n[INFO] 生成的 li.m3u 共 {len(output_content)} 行")
          print("前10行预览:")
          for j in range(min(10, len(output_content))):
              print(f"  {j+1}: {output_content[j].rstrip()}")

          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add li.m3u
          if git diff --cached --quiet; then
            echo "没有检测到 li.m3u 文件的变更，跳过提交。"
          else
            git commit -m "Auto-update: Refresh M3U playlist $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "✅ M3U 文件已成功更新并推送到仓库"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup temporary files
        run: |
          rm -f iptv.m3u
          echo "临时文件清理完成"

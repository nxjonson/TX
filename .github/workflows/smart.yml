name: smart

on:
  schedule:
    - cron: '45 21 */2 * *'  # UTC 21:45 每两天运行一次（北京时间 5:45）
  workflow_dispatch:       # 允许手动触发

jobs:
  filter:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须授予写入权限，才能推送代码
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download smart.m3u
        run: |
          curl -o smart.m3u "https://raw.githubusercontent.com/judy-gotv/iptv/refs/heads/main/smart.m3u"

      - name: Filter and deduplicate M3U
        run: |
          python3 <<'PY'
          import re

          input_file = "smart.m3u"
          output_file = "1.m3u"

          allowed_groups = {"GPT-台湾"}  # 只保留台湾分组

          # 读取仓库已有的 1.m3u，用于去重
          try:
              with open(output_file, "r", encoding="utf-8") as f_existing:
                  existing_lines = set(f_existing.read().splitlines())
          except FileNotFoundError:
              existing_lines = set()

          # 读取并过滤 smart.m3u
          new_entries = []
          with open(input_file, "r", encoding="utf-8") as f_in:
              write_next = False
              for line in f_in:
                  line = line.strip()
                  if line.startswith("#EXTINF"):
                      match = re.search(r'group-title="([^"]+)"', line)
                      if match and match.group(1) in allowed_groups:
                          new_entries.append(line)
                          write_next = True
                      else:
                          write_next = False
                  elif write_next and not line.startswith("#"):
                      new_entries.append(line)
                      write_next = False

          # 追加新内容到 1.m3u
          with open(output_file, "a", encoding="utf-8") as f_out:
              for entry in new_entries:
                  if entry not in existing_lines:
                      f_out.write(entry + "\n")
          PY

      - name: Commit and push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "Auto update smart playlist"
            git push
          else
            echo "No changes to commit."
          fi

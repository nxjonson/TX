name: smart

on:
  schedule:
    - cron: '45 21 */2 * *'
  workflow_dispatch: true

jobs:
  filter:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and process playlist
        run: |
          curl -s -o /tmp/smart.m3u "https://raw.githubusercontent.com/judy-gotv/iptv/refs/heads/main/smart.m3u"
          python3 <<'PY'
          import re
          input_file = "/tmp/smart.m3u"
          output_file = "1.m3u"
          allowed_groups = {"GPT-台湾"}
          try:
              with open(output_file, "r", encoding="utf-8") as f_existing:
                  existing_lines = set(f_existing.read().splitlines())
          except FileNotFoundError:
              existing_lines = set()
          new_entries = []
          with open(input_file, "r", encoding="utf-8") as f_in:
              write_next = False
              for line in f_in:
                  line = line.strip()
                  if line.startswith("#EXTINF"):
                      match = re.search(r'group-title="([^"]+)"', line)
                      if match and match.group(1) in allowed_groups:
                          new_entries.append(line)
                          write_next = True
                      else:
                          write_next = False
                  elif write_next and not line.startswith("#"):
                      new_entries.append(line)
                      write_next = False
          with open(output_file, "a", encoding="utf-8") as f_out:
              for entry in new_entries:
                  if entry not in existing_lines:
                      f_out.write(entry + "\n")
          PY

      - name: Commit and push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add 1.m3u
          if ! git diff --staged --quiet; then
            git commit -m "Auto update smart playlist"
            git push
          fi

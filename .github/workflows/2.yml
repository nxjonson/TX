name: smart

on:
  schedule:
    - cron: '45 21 * * *'  # UTC 21:45 = 北京时间 5:45
  workflow_dispatch:       # 允许手动触发

jobs:
  filter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Filter M3U
        run: |
          python3 <<'PY'
          import re

          input_file = "smart.m3u"
          output_file = "x.m3u"

          allowed_groups = {"GPT-台湾", "GPT-香港"}

          with open(input_file, "r", encoding="utf-8") as f_in, \
               open(output_file, "w", encoding="utf-8") as f_out:

              # 写入 M3U 头
              f_out.write("#EXTM3U\n")

              # 逐行处理
              write_next = False
              for line in f_in:
                  line = line.strip()
                  if line.startswith("#EXTINF"):
                      match = re.search(r'group-title="([^"]+)"', line)
                      if match and match.group(1) in allowed_groups:
                          f_out.write(line + "\n")
                          write_next = True
                      else:
                          write_next = False
                  elif write_next and not line.startswith("#"):
                      f_out.write(line + "\n")
                      write_next = False
          PY

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add x.m3u
          git diff --staged --quiet || git commit -m "Auto-filter: keep only Taiwan and Hong Kong channels"
          git push
